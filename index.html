<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bybit User Data Lookup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1e3a8a 0%, #0f172a 100%);
        }
        .card-gradient {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-12">
            <div class="flex justify-center items-center mb-4">
                <div class="w-12 h-12 bg-blue-500 rounded-lg flex items-center justify-center mr-3">
                    <i class="fas fa-chart-line text-white text-xl"></i>
                </div>
                <h1 class="text-4xl font-bold text-white">Bybit User Data Lookup</h1>
            </div>
            <p class="text-lg text-blue-200">Enter your Bybit UID to retrieve account information and trading data</p>
        </header>

        <!-- Debug Panel -->
        <div class="max-w-4xl mx-auto mb-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fas fa-bug text-yellow-500 text-xl mr-3"></i>
                    <div>
                        <h3 class="font-semibold text-yellow-800">Debug Mode</h3>
                        <p class="text-yellow-700 text-sm">Troubleshooting data loading issues</p>
                    </div>
                </div>
                <button onclick="toggleDebug()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-sm">
                    Toggle Debug
                </button>
            </div>
            <div id="debugInfo" class="mt-3 hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                        <strong>Data Load Status:</strong> 
                        <span id="dataStatus">Not loaded</span>
                    </div>
                    <div>
                        <strong>Total Records:</strong> 
                        <span id="recordCount">0</span>
                    </div>
                    <div>
                        <strong>First Record UID:</strong> 
                        <span id="firstUID">-</span>
                    </div>
                    <div>
                        <strong>Last Error:</strong> 
                        <span id="lastError">None</span>
                    </div>
                </div>
                <div class="mt-3">
                    <button onclick="viewRawData()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm mr-2">
                        View Raw Data
                    </button>
                    <button onclick="forceReload()" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">
                        Force Reload
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-4xl mx-auto">
            <!-- Search Card -->
            <div class="card-gradient rounded-2xl shadow-2xl p-8 mb-8">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Find Your Bybit Data</h2>
                    <p class="text-gray-600">Enter your unique Bybit UID to access your trading information</p>
                </div>

                <!-- Search Form -->
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-user-circle mr-2 text-blue-500"></i>
                            Bybit UID
                        </label>
                        <input 
                            type="text" 
                            id="uidInput" 
                            placeholder="Enter your Bybit UID (e.g., 485218082)" 
                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg"
                        >
                        <p class="text-sm text-gray-500 mt-1">Try both numeric and text formats</p>
                    </div>

                    <div class="flex gap-4">
                        <button 
                            onclick="searchByUID()" 
                            class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-3 px-6 rounded-xl transition duration-200 font-semibold flex items-center justify-center"
                        >
                            <i class="fas fa-search mr-2"></i>
                            Search User Data
                        </button>
                        <button 
                            onclick="loadSampleData()" 
                            class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 px-6 rounded-xl transition duration-200 font-semibold flex items-center justify-center"
                        >
                            <i class="fas fa-eye mr-2"></i>
                            View Sample Data
                        </button>
                    </div>
                </div>

                <!-- Quick Examples -->
                <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                    <h4 class="font-semibold text-blue-800 mb-2 flex items-center">
                        <i class="fas fa-lightbulb mr-2"></i>
                        Quick Test UIDs:
                    </h4>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="setUID('485218082')" class="text-sm bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-2 rounded-lg transition duration-150">
                            UID: 485218082
                        </button>
                        <button onclick="setUID('485218083')" class="text-sm bg-green-100 hover:bg-green-200 text-green-700 px-3 py-2 rounded-lg transition duration-150">
                            UID: 485218083
                        </button>
                        <button onclick="setUID('485218084')" class="text-sm bg-purple-100 hover:bg-purple-200 text-purple-700 px-3 py-2 rounded-lg transition duration-150">
                            UID: 485218084
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="hidden">
                <!-- User Found -->
                <div id="userFound" class="hidden">
                    <!-- User Summary -->
                    <div class="card-gradient rounded-2xl shadow-2xl p-6 mb-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">
                                    <i class="fas fa-user-check text-green-500 mr-2"></i>
                                    User Found
                                </h3>
                                <p class="text-gray-600" id="userSummary">UID: <span id="foundUID"></span></p>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-green-600" id="kycLevel"></div>
                                <div class="text-sm text-gray-500">KYC Level</div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Data Card -->
                    <div class="card-gradient rounded-2xl shadow-2xl p-6 mb-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-database text-blue-500 mr-2"></i>
                            User Data Overview
                        </h3>
                        <div id="userData" class="space-y-4"></div>
                    </div>

                    <!-- Raw JSON Data -->
                    <div class="card-gradient rounded-2xl shadow-2xl p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-code text-gray-500 mr-2"></i>
                            Complete Data
                        </h3>
                        <pre id="rawData" class="bg-gray-800 text-green-400 p-4 rounded-lg overflow-x-auto text-sm"></pre>
                    </div>
                </div>

                <!-- User Not Found -->
                <div id="userNotFound" class="hidden card-gradient rounded-2xl shadow-2xl p-8 text-center">
                    <div class="text-6xl text-yellow-500 mb-4">
                        <i class="fas fa-user-slash"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">User Not Found</h3>
                    <p class="text-gray-600 mb-4" id="notFoundMessage">The UID you entered doesn't exist in our database.</p>
                    <div class="text-left bg-yellow-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-yellow-800 mb-2">Troubleshooting Tips:</h4>
                        <ul class="text-sm text-yellow-700 space-y-1">
                            <li>• Check that the UID exists in your Google Sheet</li>
                            <li>• Try the UID as both number and text (e.g., "485218082" vs 485218082)</li>
                            <li>• Verify the column name in your sheet is exactly "UID"</li>
                            <li>• Check that your Google Apps Script is returning data</li>
                        </ul>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="loadingState" class="hidden card-gradient rounded-2xl shadow-2xl p-8 text-center">
                    <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500 mx-auto mb-4"></div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Searching Database</h3>
                    <p class="text-gray-600">Looking up user information...</p>
                </div>
            </div>

            <!-- Data Preview -->
            <div id="dataPreview" class="card-gradient rounded-2xl shadow-2xl p-6 mt-8 hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-table text-blue-500 mr-2"></i>
                    Loaded Data Preview
                </h3>
                <div id="previewContent" class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="bg-gray-100">
                            <tr id="previewHeaders"></tr>
                        </thead>
                        <tbody id="previewBody" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Raw Data Modal -->
    <div id="rawDataModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Raw Data from Google Sheets</h3>
                <button onclick="closeRawData()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <pre id="modalRawData" class="bg-gray-800 text-green-400 p-4 rounded overflow-x-auto text-xs"></pre>
        </div>
    </div>

    <script>
        const scriptUrl = 'https://script.google.com/macros/s/AKfycbzf7Faa_Iuqx17TJ-Ok98-1v_Y4hXnnIGHt1XjxszVzb9SMjgIEWx4xVF6VEE9L7by6/exec';
        let allUserData = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
        });

        // Load all data from Google Sheets
        async function loadAllData() {
            updateDebugInfo('Loading...', 'yellow');
            try {
                const response = await fetch(scriptUrl);
                const data = await response.json();
                
                if (Array.isArray(data) && data.length > 0) {
                    allUserData = data;
                    updateDebugInfo('Loaded successfully', 'green');
                    updateRecordCount(data.length);
                    updateFirstUID(data[0]);
                    showDataPreview(data);
                    console.log('Loaded user data:', data);
                } else {
                    throw new Error('No data or invalid format received');
                }
            } catch (error) {
                console.error('Error loading data:', error);
                updateDebugInfo('Load failed', 'red');
                updateLastError(error.message);
                // Load sample data if live data fails
                loadSampleDataset();
            }
        }

        // Search by UID with multiple matching strategies
        async function searchByUID() {
            const uidInput = document.getElementById('uidInput').value.trim();
            
            if (!uidInput) {
                alert('Please enter a Bybit UID');
                return;
            }

            showLoading();

            setTimeout(() => {
                try {
                    if (allUserData.length === 0) {
                        updateNotFoundMessage('No data loaded from Google Sheets. Please check your connection.');
                        showUserNotFound();
                        return;
                    }

                    console.log('Searching for UID:', uidInput);
                    console.log('Available UIDs:', allUserData.map(u => u.UID));

                    // Try multiple matching strategies
                    let user = null;

                    // Strategy 1: Exact numeric match
                    const numericUID = Number(uidInput);
                    if (!isNaN(numericUID)) {
                        user = allUserData.find(u => Number(u.UID) === numericUID);
                    }

                    // Strategy 2: String match
                    if (!user) {
                        user = allUserData.find(u => String(u.UID) === uidInput);
                    }

                    // Strategy 3: Case-insensitive string match
                    if (!user) {
                        user = allUserData.find(u => String(u.UID).toLowerCase() === uidInput.toLowerCase());
                    }

                    // Strategy 4: Partial match
                    if (!user) {
                        user = allUserData.find(u => String(u.UID).includes(uidInput));
                    }

                    if (user) {
                        console.log('User found:', user);
                        displayUserData(user);
                    } else {
                        console.log('User not found. Available UIDs:', allUserData.map(u => u.UID));
                        updateNotFoundMessage(`UID "${uidInput}" not found. Available UIDs: ${allUserData.slice(0, 5).map(u => u.UID).join(', ')}${allUserData.length > 5 ? '...' : ''}`);
                        showUserNotFound();
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    updateNotFoundMessage(`Search error: ${error.message}`);
                    showUserNotFound();
                }
            }, 1000);
        }

        // Display user data
        function displayUserData(user) {
            hideLoading();
            document.getElementById('resultsSection').classList.remove('hidden');
            document.getElementById('userFound').classList.remove('hidden');
            document.getElementById('userNotFound').classList.add('hidden');

            // Update summary
            document.getElementById('foundUID').textContent = user.UID;
            document.getElementById('kycLevel').textContent = user['KYC(Lv.)'] || '0';

            // Display detailed data
            const userDataDiv = document.getElementById('userData');
            userDataDiv.innerHTML = createUserDataHTML(user);

            // Display raw JSON
            document.getElementById('rawData').textContent = JSON.stringify(user, null, 2);
        }

        // Create HTML for user data display
        function createUserDataHTML(user) {
            const fields = [
                { label: 'VIP Level', value: user['VIP Level'] || 'Not Set', icon: 'crown', color: 'text-yellow-600' },
                { label: 'User Engagement', value: user['User engagement'] || 'Unknown', icon: 'activity', color: 'text-green-600' },
                { label: 'Joined Bybit', value: formatDate(user['Joined Bybit']), icon: 'calendar', color: 'text-blue-600' },
                { label: 'Source', value: user['Source'] || 'Unknown', icon: 'source', color: 'text-purple-600' },
                { label: 'Coin', value: user['Coin'] || 'USDT', icon: 'coins', color: 'text-yellow-500' },
                { label: 'First-Time Deposited', value: user['First-Time Deposited'] || 'Not Yet', icon: 'download', color: 'text-green-500' },
                { label: 'Deposits Amount', value: formatNumber(user['Deposits Amount'] || 0), icon: 'money-bill-wave', color: 'text-green-600' },
                { label: 'Trading Amount', value: formatNumber(user['TradingAmount'] || 0), icon: 'chart-bar', color: 'text-blue-500' },
                { label: 'Taker Amount', value: formatNumber(user['TakerAmount'] || 0), icon: 'arrow-up', color: 'text-red-500' },
                { label: 'Maker Amount', value: formatNumber(user['MakerAmount'] || 0), icon: 'arrow-down', color: 'text-blue-500' },
                { label: 'Interest', value: formatNumber(user['Interest'] || 0), icon: 'percent', color: 'text-purple-500' },
                { label: 'Fee Profit', value: formatNumber(user['Fee Profit'] || 0), icon: 'dollar-sign', color: 'text-green-500' },
                { label: 'Commissions', value: formatNumber(user['Commissions'] || 0), icon: 'hand-holding-usd', color: 'text-orange-500' },
                { label: 'Tradfi Amount', value: formatNumber(user['Tradfi Amount'] || 0), icon: 'exchange-alt', color: 'text-indigo-500' },
                { label: 'Rebate Coin', value: user['Rebate Coin'] || 'USDT', icon: 'gift', color: 'text-pink-500' }
            ];

            return fields.map(field => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center">
                        <i class="fas fa-${field.icon} ${field.color} mr-3"></i>
                        <div>
                            <div class="font-semibold text-gray-700">${field.label}</div>
                            <div class="text-sm text-gray-500">${field.value}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Show user not found
        function showUserNotFound() {
            hideLoading();
            document.getElementById('resultsSection').classList.remove('hidden');
            document.getElementById('userFound').classList.add('hidden');
            document.getElementById('userNotFound').classList.remove('hidden');
        }

        function updateNotFoundMessage(message) {
            document.getElementById('notFoundMessage').textContent = message;
        }

        // Show loading state
        function showLoading() {
            document.getElementById('resultsSection').classList.remove('hidden');
            document.getElementById('userFound').classList.add('hidden');
            document.getElementById('userNotFound').classList.add('hidden');
            document.getElementById('loadingState').classList.remove('hidden');
        }

        // Hide loading state
        function hideLoading() {
            document.getElementById('loadingState').classList.add('hidden');
        }

        // Set UID from quick examples
        function setUID(uid) {
            document.getElementById('uidInput').value = uid;
        }

        // Load sample data for demonstration
        function loadSampleData() {
            const sampleUser = {
                "UID": 485218082,
                "VIP Level": "VIP 1",
                "User engagement": "Above 180",
                "Joined Bybit": "2025-07-04T03:43:26.000Z",
                "Source": "CSTAPPTELEGR",
                "Remarks": "Active Trader",
                "KYC(Lv.)": 1,
                "Coin": "USDT",
                "First-Time Deposited": "2025-07-05",
                "Deposits Amount": 1500,
                "TradingAmount": 12500,
                "TakerAmount": 8000,
                "MakerAmount": 4500,
                "Interest": 25.50,
                "Fee Profit": 45.75,
                "Commissions": 12.30,
                "Tradfi Amount": 3200,
                "Rebate Coin": "USDT"
            };
            
            setUID(sampleUser.UID);
            displayUserData(sampleUser);
        }

        // Sample dataset for fallback
        function loadSampleDataset() {
            allUserData = [
                {
                    "UID": 485218082,
                    "VIP Level": "VIP 1",
                    "User engagement": "Above 180",
                    "Joined Bybit": "2025-07-04T03:43:26.000Z",
                    "Source": "CSTAPPTELEGR",
                    "Remarks": "Active Trader",
                    "KYC(Lv.)": 1,
                    "Coin": "USDT",
                    "First-Time Deposited": "2025-07-05",
                    "Deposits Amount": 1500,
                    "TradingAmount": 12500,
                    "TakerAmount": 8000,
                    "MakerAmount": 4500,
                    "Interest": 25.50,
                    "Fee Profit": 45.75,
                    "Commissions": 12.30,
                    "Tradfi Amount": 3200,
                    "Rebate Coin": "USDT"
                },
                {
                    "UID": "485218083", // Test with string UID
                    "VIP Level": "",
                    "User engagement": "Below 90",
                    "Joined Bybit": "2025-08-10T10:20:15.000Z",
                    "Source": "WEB",
                    "Remarks": "New User",
                    "KYC(Lv.)": 0,
                    "Coin": "USDT",
                    "First-Time Deposited": "",
                    "Deposits Amount": 0,
                    "TradingAmount": 0,
                    "TakerAmount": 0,
                    "MakerAmount": 0,
                    "Interest": 0,
                    "Fee Profit": 0,
                    "Commissions": 0,
                    "Tradfi Amount": 0,
                    "Rebate Coin": "USDT"
                }
            ];
            updateDebugInfo('Using sample data', 'yellow');
            updateRecordCount(allUserData.length);
            updateFirstUID(allUserData[0]);
            showDataPreview(allUserData);
        }

        // Debug functions
        function updateDebugInfo(status, color) {
            const element = document.getElementById('dataStatus');
            element.textContent = status;
            element.className = `text-${color}-600 font-semibold`;
        }

        function updateRecordCount(count) {
            document.getElementById('recordCount').textContent = count;
        }

        function updateFirstUID(firstRecord) {
            document.getElementById('firstUID').textContent = firstRecord ? firstRecord.UID : '-';
        }

        function updateLastError(error) {
            document.getElementById('lastError').textContent = error;
        }

        function toggleDebug() {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.classList.toggle('hidden');
        }

        function viewRawData() {
            document.getElementById('modalRawData').textContent = JSON.stringify(allUserData, null, 2);
            document.getElementById('rawDataModal').classList.remove('hidden');
        }

        function closeRawData() {
            document.getElementById('rawDataModal').classList.add('hidden');
        }

        function forceReload() {
            loadAllData();
        }

        function showDataPreview(data) {
            if (data.length === 0) return;
            
            const preview = document.getElementById('dataPreview');
            const headers = document.getElementById('previewHeaders');
            const body = document.getElementById('previewBody');
            
            const sample = data[0];
            const sampleHeaders = Object.keys(sample).slice(0, 6); // Show first 6 columns
            
            headers.innerHTML = sampleHeaders.map(header => 
                `<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">${header}</th>`
            ).join('');
            
            body.innerHTML = data.slice(0, 5).map(row => `
                <tr>
                    ${sampleHeaders.map(header => 
                        `<td class="px-4 py-2 text-sm text-gray-700 border-t">${row[header] || ''}</td>`
                    ).join('')}
                </tr>
            `).join('');
            
            preview.classList.remove('hidden');
        }

        // Utility functions
        function formatNumber(num) {
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(num);
        }

        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } catch {
                return dateString;
            }
        }

        // Enter key support
        document.getElementById('uidInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchByUID();
            }
        });
    </script>
</body>
</html>
